<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>indexedDB - Open Database</title>
    <style type="text/css">
      @import "../../dijit/themes/claro/claro.css";
      @import "../../dijit/themes/claro/document.css";
      @import "../../dijit/tests/css/dijitTests.css";
      @import "../themes/claro/claro.css";
    </style>

		<script type="text/javascript">
			var dojoConfig = {
            async: true,
            parseOnLoad: true,
            isDebug: true,
            baseUrl: "/js/dojotoolkit/",
            packages: [
              { name: "dojo"				, location: "dojo" },
              { name: "dijit"				, location: "dijit" },
              { name: "cbtree"			, location: "cbtree" },
              { name: "indexedDB"		, location: "indexedDB" },
              { name: "indexedStore", location: "indexedStore" }
            ]
			};

		</script>

    <script type="text/javascript" src="/js/dojotoolkit/dojo/dojo.js"></script>
		<script type="text/javascript">
			require(["dojo/ready",
							 "dojo/Deferred",
							 "dojo/on",
							 "dojo/when",
							 "cbtree/Tree",
							 "cbtree/models/ObjectStoreModel",
							 "indexedDB/IDBEnvironment!enforce",
							 "indexedDB/store/Evented",
							 "indexedDB/store/Observable",
							 "indexedDB/store/Store"
							], function(ready, Deferred, on, when, Tree, ObjectStoreModel, indexedDB,
													 Evented, Observable, indexedStore) {

				var dbReady = new Deferred();
				var store, model;
				var database = {
					stores: [
						{ url:"./Simpsons.json", name:"characters", storeOptions:{keyPath:"name"},
							indexes: [
								{ name:"parents", keyPath:"parent", indexOptions:{multiEntry:true}}
							]
						}
					]
				};

				function openDatabase( dbName, options ) {
					var hasConn = new Deferred();
					var request;

					indexedDB.deleteDatabase(dbName);
					var request = indexedDB.open(dbName, 1, options);
					request.onupgradeneeded = function (event) {
						// Typically your db store and index creation goes here...
					}
					request.onsuccess = function (event) {
						hasConn.resolve( this.result );
					}
					request.onerror = hasConn.reject;
					return hasConn.promise;
				}

				openDatabase("indexedDB/database/SimpsonsDB", database).then (
					function (dbConn) {
						console.log( "We have a connection on: " + dbConn.name);
						var dbStore = new indexedStore( dbConn, "characters", {parentIndex:"parents"} );

//						var store = Evented(dbStore);
						store = Observable(dbStore);
						model = new ObjectStoreModel( { store: store,
																						query: {name: "Root"},
                                            rootLabel: "The Simpsons",
                                            checkedRoot: true
                                           });
            dbReady.resolve(dbConn);

					},
					function (event) {
						console.error( event.error );
					}
				);

				ready( function() {
					when (dbReady, function() {
						var tree = new Tree( { model: model, id: "FamilyTree", persist:false }, "CheckboxTree" );
						tree.startup();
					});
				});

			});
		</script>
  </head>

  <body class="claro">
    <div id="CheckboxTree">
    </div>
  </body>
</html>